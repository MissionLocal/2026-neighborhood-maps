<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bayview resources</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://pym.nprapps.org/pym.v1.min.js"></script>

  <style>
    body { margin:0; padding:0 0 20px 0; font-family:'Barlow',sans-serif; }

    .cont { display:flex; justify-content:center; align-items:center; }

    .map-wrapper {
      position:relative;
      width:100vw;
      max-width:400px;
      margin:10px auto;
    }

    #map {
      width:100%;
      height:500px;
      box-shadow:0 4px 8px rgba(0,0,0,.1);
    }

    .filter-label {
      text-align:center;
      font-size:13px;
      margin:6px 0 4px;
    }

    #filters {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      margin-bottom:8px;
    }

    #filters button {
      font-family:'Barlow',sans-serif;
      font-size:12px;
      padding:4px 8px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
    }

    #filters button.active {
      background:#eee;
    }

    #clear-filters {
      text-align:center;
      font-size:12px;
      color:#555;
      cursor:pointer;
      margin-bottom:6px;
      display:none;
    }

    .credit {
      text-align:center;
      font-size:11px;
      color:#555;
      margin-top:8px;
    }

    /* INFO CARD (matches your turnout map) */
/* stage that matches the map box exactly */
.map-stage{
  position: relative;
  width: 100%;
}

/* keep map sizing as-is */
#map{
  width: 100%;
  height: 500px;                 /* or whatever you use */
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
}

/* info card positioned relative to the map box */
#custom-popup{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 14px;                  /* now this is the map bottom */
  z-index: 10;

  width: calc(100% - 12px);
  max-width: 460px;
  box-sizing: border-box;

  padding: 8px 10px;
  background: rgba(255,255,255,.98);
  border-radius: 2px;
  box-shadow: 0 2px 4px rgba(0,0,0,.10);

  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  line-height: 1.35;

  max-height: 40%;
  overflow-y: auto;

  display: none;
}



    #popup-content div { margin-bottom:6px; }

    #popup-content hr{
      border:0;
      border-top:1px solid rgba(0,0,0,.12);
      margin:8px 0;
    }

    #popup-content strong{ font-weight:600; }

    #popup-content a{
      color:#555;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    #popup-content a:hover{ color:#111; }

    @media (max-width:768px){
      .map-wrapper{ max-width:400px; }
      #map{ height:500px; }
    }
  </style>
</head>

<body>

<div class="cont">
  <div class="map-wrapper">

    <p class="filter-label"><em>Click to filter by category</em></p>

    <div id="filters">
      <button data-category="School">School</button>
      <button data-category="Health care">Health care</button>
      <button data-category="Library">Library</button>
      <button data-category="Services">Services</button>
      <button data-category="Police station">Police Station</button>
    </div>

    <div id="clear-filters">Ã— remove filters</div>

    <div class="map-stage">
  <div id="map"></div>
  <div id="custom-popup"><div id="popup-content"></div></div>
</div>

<p class="credit">Source: Data compiled by Marina Newman. Map by Xueer Lu.</p>


  </div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibWxub3ciLCJhIjoiY21scG5hY2V5MHdwODNkcHRxb2Nhc2N5NyJ9.Ccmhr38K26uGXhVqe1yepA';

const pymChild = new pym.Child();
function sendHeight(){ pymChild.sendHeight(); }

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mlnow/cmis0bnr0000401sr9iyb6i1a',
  center: [-122.3854085, 37.7318363],
  zoom: 11.6,
  maxBounds: [
    [-122.432, 37.695],
    [-122.340, 37.765]
  ]
});

map.on('load', () => {

  map.addSource('locations', {
    type: 'geojson',
    data: './bayview-resources.geojson'
  });

  map.addLayer({
    id: 'resources',
    type: 'circle',
    source: 'locations',
    paint: {
      'circle-radius': 8,
      'circle-opacity': 0.9,
      'circle-color': [
        'match',
        ['get','Category'],
        'School','#46c134',
        'Health care','#57a4ea',
        'Library','#f67cf6',
        'Services','#efbe25',
        'Police station','#f36e57',
        '#cccccc'
      ]
    }
  });

  const activeCategories = new Set();
  const buttons = document.querySelectorAll('#filters button');
  const clearBtn = document.getElementById('clear-filters');

  function updateFilter(){
    if(activeCategories.size===0){
      map.setFilter('resources', null);
      clearBtn.style.display='none';
      return;
    }
    map.setFilter('resources',[
      'in',
      ['get','Category'],
      ['literal',Array.from(activeCategories)]
    ]);
    clearBtn.style.display='block';
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const cat=btn.dataset.category;
      if(activeCategories.has(cat)){
        activeCategories.delete(cat);
        btn.classList.remove('active');
      }else{
        activeCategories.add(cat);
        btn.classList.add('active');
      }
      updateFilter();
    });
  });

  clearBtn.addEventListener('click',()=>{
    activeCategories.clear();
    buttons.forEach(b=>b.classList.remove('active'));
    map.setFilter('resources',null);
    clearBtn.style.display='none';
  });

  map.on('click','resources',(e)=>{
    const p=e.features[0].properties;

    let content=`<div><strong>${p.Item||''}</strong></div>`;
    content+=`<div>${p.Address||''}</div>`;

    const hasDetails=p.Type||p.Phone||p.About;
    if(hasDetails) content+=`<hr>`;

    if(p.Type) content+=`<div><strong>Type:</strong> ${p.Type}</div>`;

    if(p.Phone){
      const raw=String(p.Phone);
      const tel=raw.replace(/[^\d+]/g,'');
      content+=`<div><strong>Phone:</strong> <a href="tel:${tel}">${raw}</a></div>`;
    }

    if(p.About) content+=`<div><strong>About:</strong> ${p.About}</div>`;

    document.getElementById('popup-content').innerHTML=content;
    document.getElementById('custom-popup').style.display='block';

    sendHeight();
  });

  map.on('click',(e)=>{
    const features=map.queryRenderedFeatures(e.point,{layers:['resources']});
    if(features.length) return;
    document.getElementById('custom-popup').style.display='none';
    sendHeight();
  });

  map.on('mouseenter','resources',()=>{ map.getCanvas().style.cursor='pointer'; });
  map.on('mouseleave','resources',()=>{ map.getCanvas().style.cursor=''; });

});

window.addEventListener('resize',sendHeight);
window.addEventListener('load',sendHeight);
</script>

</body>
</html>
